name: Auto-fix Issues with Claude

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    # Only run on new issues or when someone comments "/claude fix"
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/claude fix'))

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install @anthropic-ai/sdk

      - name: Analyze issue and create fix
        id: claude_fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_NAME: ${{ github.repository }}
        run: |
          node .github/scripts/fix-issue.js

      - name: Create Pull Request
        if: steps.claude_fix.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix: ${{ github.event.issue.title }}

            Fixes #${{ github.event.issue.number }}

            ðŸ¤– Generated with Claude Code (https://claude.com/claude-code)

            Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
          branch: claude-fix-issue-${{ github.event.issue.number }}
          title: "fix: ${{ github.event.issue.title }}"
          body: |
            ## Automated Fix for Issue #${{ github.event.issue.number }}

            This PR was automatically created by Claude to address the reported issue.

            ### Original Issue
            ${{ github.event.issue.title }}

            ### Changes Made
            ${{ steps.claude_fix.outputs.summary }}

            ### How to Review
            1. Check the changes in the Files Changed tab
            2. Test the fix locally if needed
            3. Approve and merge if the fix looks good
            4. If the fix needs adjustments, comment on this PR and I can iterate

            ---
            ðŸ¤– **Auto-generated by Claude** | Closes #${{ github.event.issue.number }}
          labels: |
            automated-fix
            claude

      - name: Comment on issue if no fix possible
        if: steps.claude_fix.outputs.has_changes != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ¤– **Claude Analysis**\n\n${{ steps.claude_fix.outputs.analysis }}\n\n---\n*I couldn't automatically fix this issue, but I've provided analysis above. A human developer may need to take a look.*`
            })
